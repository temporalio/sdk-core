syntax = "proto3";

package coresdk;

// Note: Intellij will think these imports don't work because of the slightly odd nature of
// the include paths. You can make it work by going to the "Protobuf Support" settings section
// and adding the "api_upstream" subdir as an include path.

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "dependencies/gogoproto/gogo.proto";
import "temporal/api/workflowservice/v1/request_response.proto";
import "temporal/api/taskqueue/v1/message.proto";
import "temporal/api/enums/v1/failed_cause.proto";
import "temporal/api/failure/v1/message.proto";
import "temporal/api/common/v1/message.proto";
import "temporal/api/command/v1/message.proto";

// TODO: Use the SDK prefix?
message WorkflowIdentifier {
    string namespace = 1;
    string name = 2;
}

message ActivityIdentifier {
    string namespace = 1;
    string name = 2;
}

message RegistrationReq {
    repeated WorkflowIdentifier workflows = 1;
    repeated ActivityIdentifier activities = 2;
}

// TODO: SDK prefix in front of everything is maybe pointless given it's all within this package

service CoreSDKService {
    rpc PollSDKTask (google.protobuf.Empty) returns (PollSDKTaskResp) {}
    rpc CompleteSDKTask (CompleteSDKTaskReq) returns (google.protobuf.Empty) {}
    rpc RegisterImplementations (RegistrationReq) returns (google.protobuf.Empty) {}
}

message PollSDKTaskResp {
    bytes task_token = 1;
    oneof task {
        SDKWFTask wf_task = 2;
        SDKActivityTask activity_task = 3;
    }
}

message StartWorkflowTaskAttributes {
    string namespace = 1;
    string name = 2;
    temporal.api.common.v1.Payloads arguments = 3;
}

message CompleteTimerTaskAttributes {
    int32 timer_id = 1;
}

message CancelTimerTaskAttributes {
    int32 timer_id = 1;
}

// TODO: Remove this - type info exists in attributes oneof
enum WFTaskType {
    START_WORKFLOW = 0;
    COMPLETE_TIMER = 1;
    CANCEL_TIMER = 2;
}

message SDKWFTask {
    WFTaskType type = 1;
    google.protobuf.Timestamp timestamp = 2 [(gogoproto.stdtime) = true];
    string workflow_id = 3;
    oneof attributes {
        StartWorkflowTaskAttributes start_workflow_task_attributes = 4;
        CompleteTimerTaskAttributes complete_timer_task_attributes = 5;
        CancelTimerTaskAttributes cancel_timer_task_attributes = 6;
    }
}

message SDKActivityTask {
    // Original task from temporal service
    temporal.api.workflowservice.v1.PollActivityTaskQueueResponse original = 1;
}


message CompleteSDKTaskReq {
    bytes task_token = 1;
    oneof completion {
        SDKWFTaskCompletion workflow = 2;
        SDKActivityTaskCompletion activity = 3;
    }
}

message SDKWFTaskCompletion {
    oneof status {
        SDKWFTaskSuccess successful = 1;
        SDKWFTaskFailure failed = 2;
    }
}

message SDKActivityTaskCompletion {
    oneof status {
        SDKActivityTaskSuccess successful = 1;
        SDKActivityTaskFailure failed = 2;
    }
}

message SDKWFTaskSuccess {
    repeated temporal.api.command.v1.Command commands = 1;
    // Other bits from RespondWorkflowTaskCompletedRequest as needed
}

message SDKWFTaskFailure {
    temporal.api.enums.v1.WorkflowTaskFailedCause cause = 1;
    temporal.api.failure.v1.Failure failure = 2;
    // Other bits from RespondWorkflowTaskFailedRequest as needed
}

message SDKActivityTaskSuccess {
    temporal.api.common.v1.Payloads result = 1;
    // Other bits from RespondActivityTaskCompletedRequest as needed
}

message SDKActivityTaskFailure {
    temporal.api.failure.v1.Failure failure = 1;
    // Other bits from RespondActivityTaskFailedRequest as needed
}
